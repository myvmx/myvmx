<# 
get vulnerability assessment settings for SQL server and store in object to be exported if needed
#>

# Get All Subscription
$AzSubs = Get-AzSubscription
# Variable to sort results
$SQLCSV = @()
# Loop through all subscriptions
foreach ($AzSub in $AzSubs)
    {
    # Set Scope for subscription
    Set-AzContext $azsub.id
    #Get all SQL Servers
    $AzSQLServers = Get-AzSqlServer
    # Loop through all SQL Servers    
    foreach ($AzSQLServer in $AzSQLServers)
        {
        # Get Vulnerability Settings
        $AzServerVul = Get-AzSqlServerVulnerabilityAssessmentSetting -ResourceGroupName $AzSQLServer.ResourceGroupName -ServerName $AzSQLServer.ServerName
        # Sort in custom object
        $PSCustom = [PSCustomObject]@{
                ServerName        = $AzServerVul.ServerName
                ResourceGroup     = $AzServerVul.ResourceGroupName 
                NotificationEmail = $AzServerVul.NotificationEmail
            }
        # Add to variable the results
        $SQLCSV += $PSCustom
        }
    }
